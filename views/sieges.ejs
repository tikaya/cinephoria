<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Choisissez vos si√®ges - Cin√©phoria</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      display: flex; flex-direction: column; min-height: 100vh;
      background: radial-gradient(circle at center, #121829, #0a0f1f 80%);
      color: #eaeaea; font-family: 'Poppins', sans-serif;
      text-align: center; opacity: 0; transition: opacity 1s ease;
    }
    body.loaded { opacity: 1; }
    main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-bottom: 40px; }
    header, footer { width: 100%; background: rgba(10, 15, 31, 0.85); color: #eaeaea; text-align: center; padding: 12px 0; box-shadow: 0 0 15px rgba(0,0,0,0.6); font-size: 1rem; }
    h1 { margin-top: 25px; color: #f5c518; font-family: 'Cinzel', serif; text-shadow: 0 0 15px rgba(245,197,24,0.5); font-size: 2.4rem; letter-spacing: 1px; }
    .legend { margin: 20px 0; display: flex; justify-content: center; gap: 25px; font-size: 1rem; }
    .legend span { display: flex; align-items: center; gap: 8px; }
    .legend i { font-size: 1.2rem; }
    .legend .libre i { color: #2ecc71; }
    .legend .reserv√© i { color: #e74c3c; }
    .legend .pmr i { color: #3498db; }
    .legend .selected i { color: #f5c518; }
    .screen { background: linear-gradient(90deg, #f5f5f5, #ccc); height: 15px; width: 70%; margin: 15px auto 25px; border-radius: 5px; box-shadow: 0 0 30px rgba(255,255,255,0.4); position: relative; }
    .screen::after { content: "√âCRAN"; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.9rem; color: #aaa; letter-spacing: 2px; }
    .seat-map { display: grid; grid-template-columns: repeat(auto-fit, 50px); gap: 12px; justify-content: center; max-width: 850px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,0.5); }
    .seat { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 0.9rem; transition: transform 0.2s ease, box-shadow 0.3s ease, background-color 0.2s ease; cursor: pointer; text-shadow: 0 0 3px rgba(0,0,0,0.8); box-shadow: inset 0 0 5px rgba(0,0,0,0.6); }
    .seat.libre { background: #2ecc71; color: #fff; }
    .seat.reserv√© { background: #e74c3c; color: #fff; cursor: not-allowed; opacity: 0.7; }
    .seat.pmr { background: #3498db; color: #fff; }
    .seat.selected { background: #f5c518; color: #000; box-shadow: 0 0 15px #f5c518; }
    .seat:hover:not(.reserv√©):not(.selected) { transform: scale(1.15); box-shadow: 0 0 12px rgba(255,255,255,0.4); }
    .counter { font-size: 1.3rem; color: #f5c518; margin-top: 20px; font-weight: bold; }
    .btn-cinema { background: linear-gradient(45deg, #ff004d, #a700ff); color: #fff; border: none; font-weight: bold; border-radius: 6px; padding: 12px 24px; margin: 20px 12px; text-shadow: 0 0 6px rgba(0,0,0,0.8); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .btn-cinema:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(245,197,24,0.7); }
  </style>
</head>
<body>
  <header>
    <%- include('partials/header') %>
  </header>

  <main class="container">
    <h1>üé¨ Choisissez vos si√®ges</h1>

    <!-- L√©gende -->
    <div class="legend">
      <span class="libre"><i class="fas fa-chair"></i> Libre</span>
      <span class="reserv√©"><i class="fas fa-lock"></i> R√©serv√©</span>
      <span class="pmr"><i class="fas fa-wheelchair"></i> PMR</span>
      <span class="selected"><i class="fas fa-check-circle"></i> S√©lectionn√©</span>
    </div>

    <!-- √âcran -->
    <div class="screen"></div>

    <!-- Carte des si√®ges avec labels dynamiques -->
    <div class="seat-map" id="seat-map">
     <% sieges.forEach((s) => { 
     const seatLabel = s.numero_siege; // <- le vrai nom depuis la BDD, ex: "B12"
    %>
    <div
    class="seat <%= s.statut %> <%= s.type_siege === 'PMR' ? 'pmr' : '' %>"
    data-id="<%= s.id_siege %>"
    data-label="<%= seatLabel %>"
    title="Si√®ge <%= seatLabel %> (<%= s.type_siege %>)">
    <%= seatLabel %>
  </div>
  <% }) %>

    </div>

    <!-- Compteur -->
   <div class="counter">
  S√©lectionn√©s : <span id="count">0</span> / <span id="max">?</span>
  </div>
    <!-- Bouton r√©cap -->
    <a href="#" id="recap-btn" class="btn-cinema">Voir le r√©capitulatif</a>

    <!-- Retour -->
    <a href="/seances?cinemaId=<%= selectedCinema %>&filmId=<%= selectedFilm %>&nbPlaces=<%= nbPlaces %>"
       class="btn-cinema">‚¨ÖÔ∏è Retour aux s√©ances</a>
  </main>

  <footer>
    <%- include('partials/footer') %>
  </footer>

  <script>
  const seats = document.querySelectorAll('.seat');
  const count = document.getElementById('count');

  // üëâ Limite = nb de si√®ges LIBRES affich√©s (pas nbPlaces demand√© avant)
  const availableSeats = [...seats].filter(s => s.classList.contains('libre')).length;
  document.getElementById('max').textContent = availableSeats;
  const maxSeats = availableSeats;

  let selectedIds = [];
  let selectedLabels = [];

  seats.forEach(seat => {
    seat.addEventListener('click', () => {
      // On ne peut jamais cliquer un si√®ge d√©j√† r√©serv√©
      if (seat.classList.contains('reserv√©')) return;

      const selected = document.querySelectorAll('.seat.selected').length;

      // üëâ On autorise autant de s√©lections que libres (donc jusqu'√† √©puisement naturel)
      if (!seat.classList.contains('selected') && selected >= maxSeats) return;

      seat.classList.toggle('selected');

      const selectedSeats = [...document.querySelectorAll('.seat.selected')];
      selectedIds    = selectedSeats.map(s => s.dataset.id);
      selectedLabels = selectedSeats.map(s => s.dataset.label || s.textContent.trim());

      count.textContent = selectedIds.length;
    });
  });

  document.getElementById("recap-btn").addEventListener("click", (e) => {
    e.preventDefault();
    const seanceId = "<%= seanceId %>";
    const cinemaId = "<%= selectedCinema %>";
    const filmId   = "<%= selectedFilm %>";

    // üëâ nbPlaces envoy√© = nombre r√©ellement s√©lectionn√©
    const nbPlaces = selectedIds.length;

    if (nbPlaces === 0) {
      alert("Choisis au moins un si√®ge.");
      return;
    }

    const params = new URLSearchParams({
      seanceId,
      cinemaId,
      filmId,
      nbPlaces, // <-- coh√©rent avec ce qui est s√©lectionn√©
      sieges: selectedIds.join(','),
      labels: selectedLabels.join(',')
    });

    window.location.href = `/recapitulatif?${params.toString()}`;
  });

  window.addEventListener("load", () => {
    document.body.classList.add("loaded");
  });
</script>
</body>
</html>
